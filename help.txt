aws ecs run-task --cluster dev-oncokb-cluster \
  --task-definition dev-oncokb-init-rds \
  --launch-type FARGATE \
  --network-configuration "$(aws ecs describe-services \
    --cluster dev-oncokb-cluster --services dev-oncokb \
    --region us-east-1 \
    --query 'services[0].networkConfiguration' --output json)" \
  --overrides '{
    "containerOverrides": [{
      "name": "init-rds",
      "command": ["bash", "-c", "export MYSQL_PWD=$RDS_PASSWORD; mysql -h $RDS_HOST -u $RDS_USERNAME -P $RDS_PORT oncokb -e \"SHOW TABLES;\" && mysql -h $RDS_HOST -u $RDS_USERNAME -P $RDS_PORT oncokb -e \"SELECT * FROM info;\""]
    }]
  }' \
  --region us-east-1 \
  --query 'tasks[0].taskArn' --output text


# Get the task ID from the output above, then:
aws logs tail "$(terraform output -raw cloudwatch_log_group)" \
  --log-stream-name-prefix init-rds/ \
  --since 5m --region us-east-1


aws ecs list-tasks --cluster dev-oncokb-cluster \
  --family dev-oncokb-init-rds --desired-status RUNNING \
  --region us-east-1

# Also check stopped (in case it already finished)
aws ecs list-tasks --cluster dev-oncokb-cluster \
  --family dev-oncokb-init-rds --desired-status STOPPED \
  --region us-east-1

aws logs tail "$(terraform output -raw cloudwatch_log_group)" \
  --log-stream-name-prefix init-rds/ \
  --since 30m --region us-east-1

# Get the stopped task ARN
TASK_ARN=$(aws ecs list-tasks --cluster dev-oncokb-cluster \
  --family dev-oncokb-init-rds --desired-status STOPPED \
  --region us-east-1 --query 'taskArns[0]' --output text)

# Check why it stopped
aws ecs describe-tasks --cluster dev-oncokb-cluster \
  --tasks "$TASK_ARN" --region us-east-1 \
  --query 'tasks[0].{status:lastStatus,reason:stoppedReason,exitCode:containers[0].exitCode,containerReason:containers[0].reason}'

aws logs describe-log-streams \
  --log-group-name "$(terraform output -raw cloudwatch_log_group)" \
  --log-stream-name-prefix "init-rds/" \
  --order-by LastEventTime --descending \
  --limit 3 --region us-east-1 \
  --query 'logStreams[].logStreamName'
