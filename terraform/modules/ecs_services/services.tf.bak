# ECS Services

# MongoDB GRCh37 Service
resource "aws_ecs_service" "mongo_grch37" {
  cluster         = var.cluster_id
  desired_count   = 1
  launch_type     = "FARGATE"
  name            = "${var.environment}-mongo-grch37"
  task_definition = aws_ecs_task_definition.mongo_grch37.arn

  network_configuration {
    subnets = var.subnet_ids
  }

  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    service {
      discovery_name = "mongo-grch37"
      port_name      = "mongo-grch37"

      client_alias {
        dns_name = "mongo-grch37"
        port     = 27017
      }
    }
  }

  tags = {
    Environment = var.environment
    Name        = "${var.environment}-mongo-grch37"
  }
}

# MongoDB GRCh38 Service
resource "aws_ecs_service" "mongo_grch38" {
  cluster         = var.cluster_id
  desired_count   = 1
  launch_type     = "FARGATE"
  name            = "${var.environment}-mongo-grch38"
  task_definition = aws_ecs_task_definition.mongo_grch38.arn

  network_configuration {
    subnets = var.subnet_ids
  }

  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    service {
      discovery_name = "mongo-grch38"
      port_name      = "mongo-grch38"

      client_alias {
        dns_name = "mongo-grch38"
        port     = 27017
      }
    }
  }

  tags = {
    Environment = var.environment
    Name        = "${var.environment}-mongo-grch38"
  }
}

# VEP GRCh37 Service
resource "aws_ecs_service" "vep_grch37" {
  cluster          = var.cluster_id
  desired_count    = 1
  launch_type      = "FARGATE"
  platform_version = "1.4.0"
  name             = "${var.environment}-vep-grch37"
  task_definition  = aws_ecs_task_definition.vep_grch37.arn

  network_configuration {
    subnets = var.subnet_ids
  }

  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    service {
      discovery_name = "vep-grch37"
      port_name      = "vep-grch37"

      client_alias {
        dns_name = "vep-grch37"
        port     = 6060
      }
    }
  }

  tags = {
    Environment = var.environment
    Name        = "${var.environment}-vep-grch37"
  }
}

# VEP GRCh38 Service
resource "aws_ecs_service" "vep_grch38" {
  cluster          = var.cluster_id
  desired_count    = 1
  launch_type      = "FARGATE"
  platform_version = "1.4.0"
  name             = "${var.environment}-vep-grch38"
  task_definition  = aws_ecs_task_definition.vep_grch38.arn

  network_configuration {
    subnets = var.subnet_ids
  }

  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    service {
      discovery_name = "vep-grch38"
      port_name      = "vep-grch38"

      client_alias {
        dns_name = "vep-grch38"
        port     = 6061
      }
    }
  }

  tags = {
    Environment = var.environment
    Name        = "${var.environment}-vep-grch38"
  }
}

# Genome Nexus GRCh37 Service
resource "aws_ecs_service" "gn_grch37" {
  depends_on = [
    aws_ecs_service.mongo_grch37,
    aws_ecs_service.vep_grch37
  ]

  cluster         = var.cluster_id
  desired_count   = 1
  launch_type     = "FARGATE"
  name            = "${var.environment}-gn-grch37"
  task_definition = aws_ecs_task_definition.gn_grch37.arn

  network_configuration {
    subnets = var.subnet_ids
  }


  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    service {
      discovery_name = "gn-grch37"
      port_name      = "gn-grch37"

      client_alias {
        dns_name = "gn-grch37"
        port     = 8888
      }
    }
  }

  tags = {
    Environment = var.environment
    Name        = "${var.environment}-gn-grch37"
  }
}

# Genome Nexus GRCh38 Service
resource "aws_ecs_service" "gn_grch38" {
  depends_on = [
    aws_ecs_service.mongo_grch38,
    aws_ecs_service.vep_grch38
  ]

  cluster         = var.cluster_id
  desired_count   = 1
  launch_type     = "FARGATE"
  name            = "${var.environment}-gn-grch38"
  task_definition = aws_ecs_task_definition.gn_grch38.arn

  network_configuration {
    subnets = var.subnet_ids
  }


  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    service {
      discovery_name = "gn-grch38"
      port_name      = "gn-grch38"

      client_alias {
        dns_name = "gn-grch38"
        port     = 8889
      }
    }
  }

  tags = {
    Environment = var.environment
    Name        = "${var.environment}-gn-grch38"
  }
}

# OncoKB Transcript Service
resource "aws_ecs_service" "oncokb_transcript" {
  cluster         = var.cluster_id
  desired_count   = 1
  launch_type     = "FARGATE"
  name            = "${var.environment}-oncokb-transcript"
  task_definition = aws_ecs_task_definition.oncokb_transcript.arn

  network_configuration {
    subnets = var.subnet_ids
  }


  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    service {
      discovery_name = "oncokb-transcript"
      port_name      = "oncokb-transcript"

      client_alias {
        dns_name = "oncokb-transcript"
        port     = 9090
      }
    }
  }

  tags = {
    Environment = var.environment
    Name        = "${var.environment}-oncokb-transcript"
  }
}

# OncoKB API Service
resource "aws_ecs_service" "oncokb" {
  depends_on = [
    aws_ecs_service.oncokb_transcript,
    aws_ecs_service.gn_grch37,
    aws_ecs_service.gn_grch38
  ]

  cluster         = var.cluster_id
  desired_count   = 2
  launch_type     = "FARGATE"
  name            = "${var.environment}-oncokb"
  task_definition = aws_ecs_task_definition.oncokb.arn

  load_balancer {
    container_name   = "oncokb"
    container_port   = 8080
    target_group_arn = var.target_group_arn
  }

  network_configuration {
    subnets = var.subnet_ids
  }


  service_connect_configuration {
    enabled   = true
    namespace = var.service_connect_namespace_arn

    service {
      discovery_name = "oncokb"
      port_name      = "oncokb"

      client_alias {
        dns_name = "oncokb"
        port     = 8080
      }
    }
  }

  tags = {
    Environment = var.environment
    Name        = "${var.environment}-oncokb"
  }
}
